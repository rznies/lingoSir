# Lingo CLI Integration Guide

Complete documentation for Lingo CLI integration in the Global Meme Translator.

## Overview

This application uses **Lingo CLI** (via `npx lingo.dev@latest`) to translate meme captions to multiple languages. The integration includes:

- ✅ CLI command execution via Node.js child_process
- ✅ Temporary workspace management
- ✅ Batch processing for multiple languages
- ✅ Concurrent execution support
- ✅ Automatic SDK fallback
- ✅ Comprehensive error handling
- ✅ Detailed logging

## Architecture

### Files

**Backend:**
- `server.js` - Express server with translation strategy
- `src/cli-translator.js` - CLI execution and workspace management

**Configuration:**
- `.env` - Environment variables (API key, mode, batch size)
- `test-cli.js` - CLI testing script

### Translation Strategy

```
User Request → Express API → Translation Strategy
                                    ↓
                        ┌───────────┴────────────┐
                        ↓                        ↓
                   CLI Translator          SDK Translator
                        ↓                        ↓
                  ✓ Success               ✓ Fallback
                        ↓                        ↓
                    Return Translations ←────────┘
```

## CLI Command Pattern

### Basic Translation Command

```bash
npx lingo.dev@latest i18n --locale {target_language}
```

### Environment Variables

```bash
LINGODOTDEV_API_KEY=your_key npx lingo.dev@latest i18n --locale es
```

### With Configuration

Requires `i18n.json` in working directory:

```json
{
  "$schema": "https://cdn.lingo.dev/schema/v1/i18n.json",
  "locale": {
    "source": "en",
    "targets": ["es", "fr", "de"]
  },
  "files": {
    "*.json": {}
  },
  "provider": {
    "id": "lingo.dev",
    "apiKey": "your_key"
  }
}
```

## Workspace Structure

For each translation request, a temporary workspace is created:

```
/tmp/lingo-cli-{uuid}/
├── source.en.json        # Input: {"caption": "..."}
├── i18n.json            # CLI configuration
├── source.es.json       # Output: Generated by CLI
├── source.fr.json       # Output: Generated by CLI
└── source.de.json       # Output: Generated by CLI
```

### Lifecycle

1. **Create** - UUID-based directory in system temp
2. **Write** - Source JSON + i18n.json config
3. **Execute** - `npx lingo.dev@latest i18n --locale {lang}`
4. **Read** - Parse translated JSON files
5. **Cleanup** - Remove entire workspace

## Implementation Details

### src/cli-translator.js

**Class: LingoCliTranslator**

**Methods:**

```javascript
// Create temporary workspace
async createWorkspace()
// Returns: /tmp/lingo-cli-{uuid}

// Create source file
async createSourceFile(workspacePath, caption)
// Writes: source.en.json

// Create i18n config
async createConfig(workspacePath, targetLocale)
// Writes: i18n.json

// Execute CLI command
async executeCli(workspacePath, locale)
// Runs: npx lingo.dev@latest i18n --locale {locale}
// Timeout: 30 seconds

// Read translated file
async readTranslation(workspacePath, locale)
// Reads: source.{locale}.json
// Returns: translated text

// Translate to single language
async translateToLanguage(caption, targetLocale)
// Returns: { lang, text }

// Translate to multiple languages
async translateToMultipleLanguages(caption, targetLocales, options)
// Options: { batchSize, useConcurrent }
// Returns: [{ lang, text }, ...]

// Check CLI availability
async checkCliAvailability()
// Runs: npx lingo.dev@latest --version
// Returns: boolean
```

### server.js

**Translation Strategy Function:**

```javascript
async function translateWithStrategy(caption, languages) {
  // Try CLI first (if enabled)
  if (cliTranslator) {
    try {
      return await cliTranslator.translateToMultipleLanguages(
        caption,
        languages,
        { batchSize, useConcurrent }
      );
    } catch (error) {
      // Fall back to SDK
    }
  }

  // Use SDK fallback
  if (lingoDotDevSdk) {
    return await lingoDotDevSdk.batchLocalizeText(caption, {
      sourceLocale: "en",
      targetLocales: languages
    });
  }

  throw new Error("No translation method available");
}
```

## Configuration

### Environment Variables

```env
# Required
LINGODOTDEV_API_KEY=your_api_key_here

# Translation mode
TRANSLATION_MODE=hybrid    # "sdk" | "cli" | "hybrid"

# CLI settings
CLI_BATCH_SIZE=3          # Languages per batch
CLI_CONCURRENT=true       # Parallel execution
```

### Translation Modes

**SDK Mode** (`TRANSLATION_MODE=sdk`)
- Uses JavaScript SDK only
- Fast and reliable
- Best for development

**CLI Mode** (`TRANSLATION_MODE=cli`)
- Uses CLI only, no fallback
- Official Lingo integration
- Fails if CLI unavailable

**Hybrid Mode** (`TRANSLATION_MODE=hybrid`) - **RECOMMENDED**
- Tries CLI first
- Falls back to SDK if CLI fails
- Best for production

## Batch Processing

### Concurrent Batching

Translates multiple languages in parallel batches:

```javascript
// Example: 9 languages with batch size 3
const languages = ["es", "fr", "de", "it", "pt", "ja", "ko", "zh", "ar"];
const batchSize = 3;

// Creates 3 batches:
// Batch 1: es, fr, de  (parallel)
// Batch 2: it, pt, ja  (parallel)
// Batch 3: ko, zh, ar  (parallel)
```

### Configuration

```env
CLI_BATCH_SIZE=3          # Languages per batch
CLI_CONCURRENT=true       # Enable parallel execution
```

### Sequential Processing

```env
CLI_CONCURRENT=false      # Disable parallelism
```

Processes one language at a time (slower but safer).

## Error Handling

### CLI Errors

**Process Spawn Failures:**
```javascript
try {
  await executeCli(workspace, locale);
} catch (error) {
  if (error.code === 'ENOENT') {
    // CLI not found - fallback to SDK
  }
}
```

**Timeout Errors:**
```javascript
{
  timeout: 30000  // 30 second limit
}
```

**File I/O Errors:**
```javascript
try {
  const translation = await readTranslation(workspace, locale);
} catch (error) {
  // File not created or invalid JSON
  return null;
}
```

### Fallback Strategy

```
CLI Execution
    ↓
  Failed?
    ↓
 SDK Mode     → Success → Return
 Enabled?
    ↓
   Yes → SDK → Success → Return
    ↓
   No  → Throw Error
```

### Partial Failures

```javascript
// If 2 out of 3 languages succeed:
{
  results: [
    { lang: "es", text: "..." },
    { lang: "fr", text: "..." }
  ],
  errors: [
    { locale: "de", error: "..." }
  ]
}
// Returns successful translations
```

## Logging

### Server Startup

```
============================================================
  Global Meme Translator - Translation API Server
============================================================

  Server URL: http://localhost:3001
  Translation Mode: hybrid
  CLI Enabled: YES
  SDK Fallback: YES
  API Key Configured: YES
  Supported Languages: 12
  es, fr, de, it, pt, ja, ko, zh, ar, hi, ru, tr

  Checking CLI availability...
  [CLI] Lingo CLI available: 0.115.0
  CLI Status: READY ✓

============================================================
```

### Translation Request

```
[abc123] === NEW TRANSLATION REQUEST ===
[abc123] Caption: "When the code finally works"
[abc123] Languages: es, fr, ja

[STRATEGY] Attempting CLI translation...
[CLI] Translating to 3 language(s): es, fr, ja
[CLI] Batch size: 3, Concurrent: true
[CLI] Processing batch 1: es, fr, ja

[CLI] Executing translation for locale: es
[CLI] Workspace: /tmp/lingo-cli-abc123-xyz
[CLI] stdout: Translating source.en.json → source.es.json
[CLI] Translation completed in 1523ms

[CLI] Executing translation for locale: fr
[CLI] Workspace: /tmp/lingo-cli-def456-xyz
[CLI] Translation completed in 1687ms

[CLI] Executing translation for locale: ja
[CLI] Workspace: /tmp/lingo-cli-ghi789-xyz
[CLI] Translation completed in 1945ms

[CLI] Successfully translated to 3/3 language(s)
[STRATEGY] CLI translation succeeded in 5234ms

[abc123] Success: 3 translation(s) via CLI in 5234ms
```

### Error Logging

```
[abc123] === NEW TRANSLATION REQUEST ===
[STRATEGY] Attempting CLI translation...
[CLI] Executing translation for locale: es
[CLI] Execution failed after 30142ms: Command timeout
[STRATEGY] CLI translation failed: timeout
[STRATEGY] Falling back to SDK...
[STRATEGY] SDK translation succeeded in 892ms
[abc123] Success: 3 translation(s) via SDK in 31034ms
```

## Testing

### Test Script

Run CLI translation test:

```bash
npm run test:cli
```

Custom caption and languages:

```bash
npm run test:cli "Hello world" es fr de
```

### Manual Testing

**1. Create test workspace:**
```bash
mkdir test-translation && cd test-translation
```

**2. Create source file:**
```bash
echo '{"caption":"When you finally understand the codebase"}' > source.en.json
```

**3. Create config:**
```bash
cat > i18n.json << 'EOF'
{
  "$schema": "https://cdn.lingo.dev/schema/v1/i18n.json",
  "locale": {
    "source": "en",
    "targets": ["es"]
  },
  "files": {
    "*.json": {}
  }
}
EOF
```

**4. Run translation:**
```bash
LINGODOTDEV_API_KEY=your_key npx lingo.dev@latest i18n --locale es
```

**5. Check output:**
```bash
cat source.es.json
```

### API Testing

**Health check:**
```bash
curl http://localhost:3001/api/health | jq
```

**Translation:**
```bash
curl -X POST http://localhost:3001/api/translate \
  -H "Content-Type: application/json" \
  -d '{
    "caption": "When the code finally works",
    "languages": ["es", "fr", "ja"]
  }' | jq
```

**Check mode:**
```bash
curl http://localhost:3001/api/mode | jq
```

## Performance

### Benchmarks

**SDK Mode:**
- 3 languages: ~500-1000ms
- 12 languages: ~2000-3000ms

**CLI Mode:**
- 3 languages: ~3000-5000ms
- 12 languages: ~10000-15000ms

**Hybrid Mode:**
- CLI performance with SDK safety net
- First request: CLI (~3-5s)
- Fallback: SDK (~500ms-1s)

### Optimization

**Reduce batch size for faster feedback:**
```env
CLI_BATCH_SIZE=2
```

**Disable concurrency for stability:**
```env
CLI_CONCURRENT=false
```

**Use SDK for development:**
```env
TRANSLATION_MODE=sdk
```

## Troubleshooting

### CLI Not Found

**Error:**
```
Command failed: npx lingo.dev@latest i18n --locale es
/bin/sh: npx: command not found
```

**Solution:**
Ensure Node.js and npm are installed:
```bash
node --version  # Should be 18+
npm --version
```

### Permission Errors

**Error:**
```
EACCES: permission denied, mkdir '/tmp/lingo-cli-...'
```

**Solution:**
Check temp directory permissions:
```bash
ls -la /tmp
chmod 1777 /tmp  # If needed
```

### Timeout Errors

**Error:**
```
Translation timeout after 30000ms
```

**Solutions:**
1. Reduce batch size
2. Disable concurrency
3. Use SDK mode
4. Check network connection

### Output File Not Created

**Check:**
1. API key is valid
2. Source file syntax is correct
3. i18n.json config is valid
4. Target language is supported

**Debug:**
```bash
# Run CLI manually to see errors
cd /tmp/lingo-cli-test
npx lingo.dev@latest i18n --locale es
```

## Production Deployment

### Recommended Settings

```env
TRANSLATION_MODE=hybrid
CLI_BATCH_SIZE=3
CLI_CONCURRENT=true
LINGODOTDEV_API_KEY=your_production_key
```

### System Requirements

- Node.js 18+
- Write access to temp directory (`/tmp` or `%TEMP%`)
- Network access for npx
- 512MB+ available RAM

### Deployment Checklist

- ✅ Environment variables configured
- ✅ API key is valid
- ✅ Temp directory is writable
- ✅ CLI availability tested
- ✅ Fallback mode enabled (hybrid)
- ✅ Error monitoring in place
- ✅ Logs configured

## Advanced Usage

### Custom Workspace Directory

Modify `cli-translator.js`:

```javascript
async createWorkspace() {
  const workspaceId = uuidv4();
  const workspacePath = join('/custom/path', `lingo-cli-${workspaceId}`);
  await fs.mkdir(workspacePath, { recursive: true });
  return workspacePath;
}
```

### Custom Timeout

```javascript
await execPromise(`npx lingo.dev@latest i18n --locale ${locale}`, {
  cwd: workspacePath,
  env,
  timeout: 60000  // 60 seconds
});
```

### Progress Callbacks

```javascript
async translateToMultipleLanguages(caption, languages, options) {
  const { onProgress } = options;

  for (const [index, locale] of languages.entries()) {
    const result = await this.translateToLanguage(caption, locale);
    onProgress?.(index + 1, languages.length, result);
  }
}
```

## References

- [Lingo CLI Documentation](https://lingo.dev/en/cli)
- [Lingo SDK Documentation](https://docs.lingo.dev/)
- [i18n.json Schema](https://cdn.lingo.dev/schema/v1/i18n.json)

## Support

For CLI-specific issues:
1. Check server logs for detailed error messages
2. Test CLI manually using the test script
3. Verify API key and configuration
4. Try SDK fallback mode
5. Review [Lingo CLI docs](https://lingo.dev/en/cli)
